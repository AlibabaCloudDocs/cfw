# 授权云防火墙访问云资源

首次开通云防火墙的透明接入、资产识别、日志服务功能时，您需要先完成允许云防火墙访问云资源的授权。本文介绍了如何进行云资源访问授权。

-   您已购买云防火墙实例。更多信息，请参见[开通Web应用防火墙](/cn.zh-CN/产品计费/开通WAF/开通Web应用防火墙.md)。
-   您使用的是阿里云主账号或拥有创建和删除服务关联角色权限的RAM用户账号。

使用云防火墙的透明接入、资产识别、日志服务功能时，云防火墙需要访问云服务器ECS、负载均衡、CDN、证书服务、日志服务等云服务的资源，您可通过系统自动创建的云防火墙服务关联角色AliyunServiceRoleFor云防火墙获取访问权限。服务关联角色无需您手动创建或做任何修改。相关内容，请参见[服务关联角色](/cn.zh-CN/角色管理/服务关联角色.md)。

## 操作步骤

1.  登录[Web应用防火墙控制台](https://yundun.console.aliyun.com/?p=waf)[Web应用防火墙控制台](https://partners-yundun.console.aliyun.com/?p=waf)。

2.  开通云资源访问授权。

    您首次开通云防火墙的透明接入、资产识别、日志服务功能时，阿里云都会提示您需要授权云防火墙访问其他云资源。您只需从以下方式中选择一种进行授权，且只需授权一次即可：

    -   方式一：通过开通**透明接入**进行授权

        操作步骤如下：

        1.  在左侧导航栏，选择**资产中心** \> **网站接入**。
        2.  单击**网站接入**。
        3.  单击**手动添加其他网站**。
        4.  将**接入模式**设置为**透明接入**，并单击**免费开通**。
        ![透明接入（SLR）](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6995915161/p246547.png)

    -   方式二：通过开通**资产识别**进行授权

        操作步骤如下：

        1.  在左侧导航栏，选择**资产中心** \> **网站接入**。
        2.  单击**免费开通**。
        ![资产识别（SLR）](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6995915161/p246546.png)

    -   方式三：通过开通**日志服务**进行授权

        操作步骤如下：

        1.  在左侧导航栏，选择**日志管理** \> **日志服务**。
        2.  单击**立即授权**。
        ![日志服务（SLR）](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5995915161/p246543.png)

3.  开通云资源访问授权。

    您首次开通云防火墙的日志服务功能时，阿里云会提示您需要授权云防火墙访问其他云资源。具体操作如下：

    1.  在左侧导航栏，选择**日志管理** \> **日志服务**。

    2.  单击**立即授权**。

4.  在**提示**对话框，单击**确定**。

    ![提示（SLR）](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0139627161/p246536.png)

    您单击**确定**后，阿里云将自动为您创建云防火墙服务关联角色AliyunServiceRoleFor云防火墙。

    您可以在[RAM控制台](https://ram.console.aliyun.com/roles)的RAM角色管理页面，查看阿里云为云防火墙自动创建的服务关联角色。只有创建服务关联角色AliyunServiceRoleFor云防火墙后，您的云防火墙实例才能访问云服务器ECS、负载均衡、CDN、证书服务、日志服务等关联云服务的资源。

    ![AliyunServiceRoleForWaf](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/6995915161/p246540.png)


## 云防火墙服务关联角色介绍

以下是云防火墙服务关联角色的介绍：

-   角色名称：AliyunServiceRoleFor云防火墙
-   权限策略名称：AliyunServiceRolePolicyFor云防火墙

    **说明：** 该权限策略为系统默认提供的策略，策略名称和策略内容都不支持修改。

-   权限策略示例：

    ```
    {
        "Version": "1",
        "Statement": [
            {
                "Action": [
                    "ecs:DescribeInstances",
                    "ecs:DescribeNetworkInterfaces",
                    "ecs:CreateNetworkInterface",
                    "ecs:DeleteNetworkInterface",
                    "ecs:AttachNetworkInterface",
                    "ecs:DetachNetworkInterface",
                    "ecs:DescribeNetworkInterfacePermissions",
                    "ecs:CreateNetworkInterfacePermission",
                    "ecs:DeleteNetworkInterfacePermission",
                    "ecs:DescribeSecurityGroups",
                    "ecs:DescribeSecurityGroupAttribute",
                    "ecs:CreateSecurityGroup",
                    "ecs:DeleteSecurityGroup",
                    "ecs:AuthorizeSecurityGroup",
                    "ecs:RevokeSecurityGroup",
                    "ecs:DescribeDisks"
                ],
                "Resource": "*",
                "Effect": "Allow"
            },
            {
                "Action": [
                    "slb:DescribeServerCertificates",
                    "slb:DescribeDomainExtensions",
                    "slb:DescribeLoadBalancers",
                    "slb:DescribeListenerAccessControlAttribute",
                    "slb:DescribeLoadBalancerAttribute",
                    "slb:DescribeLoadBalancerHTTPListenerAttribute",
                    "slb:DescribeLoadBalancerHTTPSListenerAttribute",
                    "slb:DescribeLoadBalancerTCPListenerAttribute",
                    "slb:DescribeLoadBalancerUDPListenerAttribute"
                ],
                "Resource": "*",
                "Effect": "Allow"
            },
            {
                "Action": [
                    "cdn:DescribeUserDomains",
                    "cdn:DescribeCdnDomainDetail",
                    "cdn:DescribeDomainsBySource",
                    "cdn:DescribeUserVipsByDomain"
                ],
                "Resource": "*",
                "Effect": "Allow"
            },
            {
                "Action": [
                    "yundun-cert:DescribeUserCertificateList"
                ],
                "Resource": "*",
                "Effect": "Allow"
            },
            {
                "Action": [
                    "log:PostLogStoreLogs",
                    "log:GetProject",
                    "log:ListProject",
                    "log:GetLogStore",
                    "log:ListLogStores",
                    "log:CreateLogStore",
                    "log:CreateProject",
                    "log:GetIndex",
                    "log:CreateIndex",
                    "log:UpdateIndex",
                    "log:CreateDashboard",
                    "log:ClearLogStoreStorage",
                    "log:UpdateLogStore",
                    "log:UpdateDashboard",
                    "log:DeleteProject",
                    "log:CreateSavedSearch",
                    "log:UpdateSavedSearch",
                    "log:DeleteLogStore"
                ],
                "Resource": "acs:log:*:*:project/云防火墙*",
                "Effect": "Allow"
            },
            {
                "Action": "ram:DeleteServiceLinkedRole",
                "Resource": "*",
                "Effect": "Allow",
                "Condition": {
                    "StringEquals": {
                        "ram:ServiceName": "云防火墙.aliyuncs.com"
                    }
                }
            }
        ]
    }
    ```

    关于权限策略语法的详细说明，请参见[权限策略基本元素](/cn.zh-CN/权限策略管理/权限策略语言/权限策略基本元素.md)。


## 删除服务关联角色

如果不再需要使用云防火墙，您可以删除云防火墙服务关联角色AliyunServiceRoleFor云防火墙。在删除服务关联角色前您需要先释放已有的云防火墙实例。在释放已有的云防火墙实例后，您可以参考以下步骤，在RAM控制台删除云防火墙服务关联角色。

1.  登录[RAM控制台](https://ram.console.aliyun.com/roles)。

2.  在左侧导航栏，单击**RAM角色管理**。

3.  使用搜索功能，定位到云防火墙服务关联角色AliyunServiceRoleFor云防火墙，单击操作列的**删除**。

4.  单击**确定**。


## 相关问题

为什么我的RAM用户无法自动创建云防火墙服务关联角色AliyunServiceRoleFor云防火墙？

您需要拥有指定的权限，才能自动创建或删除AliyunServiceRoleFor云防火墙。因此，在RAM用户无法自动创建AliyunServiceRoleFor云防火墙时，您需为RAM用户添加以下权限策略。详细操作步骤指导，请参见[为RAM角色授权](/cn.zh-CN/角色管理/为RAM角色授权.md)。

```
{
    "Statement": [
        {
            "Action": [
                "ram:CreateServiceLinkedRole"
            ],
            "Resource": "acs:ram:*:主账号ID:role/*",
            "Effect": "Allow",
            "Condition": {
                "StringEquals": {
                    "ram:ServiceName": [
                        "云防火墙.aliyuncs.com"
                    ]
                }
            }
        }
    ],
    "Version": "1"
}                
```

